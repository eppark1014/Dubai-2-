"""
Few-Shot Learning을 위한 샘플 데이터
실제 Bill of Lading 수정사항 예시
"""

# 샘플 수정사항 패턴
SAMPLE_EXAMPLES = """
### 학습 예시 1: 수정 패턴
이미지 설명: "ABU DHABI, U.A.EMIRATES" 텍스트가 붉은색 박스로 표시되고, 화살표(→)가 "ABU DHABI, U.A.E"로 연결됨
분석 결과:
{
  "order": 1,
  "action": "수정",
  "original_text": "ABU DHABI, U.A.EMIRATES",
  "new_text": "ABU DHABI, U.A.E",
  "location": "Place of Receipt",
  "confidence": "high"
}

### 학습 예시 2: 여러 줄 삭제 패턴 (중요!)
이미지 설명: 두 줄의 텍스트가 함께 박스로 표시됨:
  첫 줄: "TEL:0574-87170623"
  둘째 줄: "FAX:0574-87026831"
  두 줄 모두 붉은색 박스로 묶여있고 취소선/물결표시
분석 결과:
{
  "order": 2,
  "action": "삭제",
  "original_text": "TEL:0574-87170623\\nFAX:0574-87026831",
  "new_text": "(DELETE)",
  "location": "Notify Party",
  "confidence": "high"
}
⚠️ 주의: 여러 줄이 함께 박스로 묶여있으면 모두 하나의 항목으로 인식하고 \\n으로 구분!

### 학습 예시 3: 여러 줄 수정 패턴 (중요!)
이미지 설명: 박스로 표시된 두 줄의 원본 텍스트:
  첫 줄: "LDPE FT4119"
  둘째 줄: "QUANTITY. 24.75MT"
  화살표로 연결된 손글씨 (두 줄):
  첫 줄: "COMMODITY : LDPE FT4119"
  둘째 줄: "QUANTITY : 24.75MT"
분석 결과:
{
  "order": 3,
  "action": "수정",
  "original_text": "LDPE FT4119\\nQUANTITY. 24.75MT",
  "new_text": "COMMODITY : LDPE FT4119\\nQUANTITY : 24.75MT",
  "location": "Description of Goods",
  "confidence": "high"
}
⚠️ 주의: 여러 줄의 텍스트는 각 줄을 정확히 읽고 \\n으로 구분하여 표현!

### 학습 예시 4: 위치 변경 패턴
이미지 설명: Final Destination 필드의 "NEW YORK, USA" 텍스트가 박스로 표시되고, 화살표가 "ABU DHABI, U.A.E"를 가리킴
분석 결과:
{
  "order": 4,
  "action": "수정",
  "original_text": "NEW YORK, USA",
  "new_text": "ABU DHABI, U.A.E",
  "location": "Final Destination",
  "confidence": "high"
}

### 학습 예시 5: HS CODE 삭제 패턴
이미지 설명: "HS CODE : 39011000" 텍스트가 붉은색 박스로 쳐지고 취소선(~~~ 또는 ---)이 그어짐
분석 결과:
{
  "order": 5,
  "action": "삭제",
  "original_text": "HS CODE : 39011000",
  "new_text": "(DELETE)",
  "location": "No of Containers or Other Pkgs",
  "confidence": "high"
}

### 학습 예시 6: 번호 표시 패턴 (매우 중요!) ⚠️
이미지 설명: Port of Loading 필드에 "#20" 번호가 표시되고, 그 주변에 손글씨가 있음
  - 원본 텍스트(검은색): "KHALIFA PORT, ABU DHABI, UAE"
  - #20 주변의 손글씨: "KHALIFA PORT AUH"
분석 결과:
{
  "order": 6,
  "action": "수정",
  "original_text": "KHALIFA PORT, ABU DHABI, UAE",
  "new_text": "KHALIFA PORT AUH",
  "location": "Port of Loading",
  "confidence": "high"
}
⚠️ 주의사항:
- 번호 표시(#20, #15)는 명확한 화살표 없이도 수정 지시사항입니다!
- **원본 텍스트를 완전하게 읽으세요!** "ABU DHABI"를 빠뜨리지 마세요!

### 학습 예시 7: 컨테이너 번호 정확히 읽기 (매우 중요!) ⚠️
이미지 설명: Marks and Nos 섹션의 컨테이너 번호에 붉은색 마킹
  - 원본 텍스트(검은색): "CMAU9175970\nSEAL M1246515"
  - 붉은색 손글씨: "TXGUB856491\nSEAL M1246507"
분석 결과:
{
  "order": 7,
  "action": "수정",
  "original_text": "CMAU9175970\\nSEAL M1246515",
  "new_text": "TXGUB856491\\nSEAL M1246507",
  "location": "Marks and Nos",
  "confidence": "high"
}
⚠️ 주의사항:
- **컨테이너 번호의 모든 숫자를 정확히 읽으세요!**
- 9175970 ≠ 9157090 (5와 7의 순서 주의!)
- 숫자 하나하나를 신중하게 읽으세요!
"""

# 패턴 인식 가이드
PATTERN_GUIDE = """
## 수정/삭제 패턴 인식 가이드

### 1. 수정(Modification) 패턴의 특징:
✓ 화살표 존재: →, ➔, ⇒, -->, =>
✓ 원본 텍스트 + 화살표 + 새 텍스트 구조
✓ "변경", "수정", "change" 등의 단어
✓ 두 개의 텍스트가 연결됨
✓ 번호 표시: #1, #2, #20, #15 등 (수정 항목 번호)

### 2. 삭제(Deletion) 패턴의 특징:
✓ 물결표시: ~~~, ≈≈≈
✓ 취소선: ---, ━━━
✓ X 표시: ✕, ✗, ×
✓ "삭제", "delete", "remove" 등의 단어
✓ 박스/동그라미만 있고 화살표 없음

### 2-1. 약한 마킹 / 번호 표시 패턴 (중요!) ⚠️
**명확한 화살표나 취소선이 없어도:**
✓ 박스, 밑줄, 동그라미로 표시된 텍스트
✓ 번호 표시(#1, #2, #3 등)와 함께 손글씨
✓ 붉은색/분홍색으로 강조된 영역
✓ 텍스트 주변의 붉은 마킹
→ 이런 경우도 수정/삭제 지시사항일 가능성이 높음!

### 3. 여러 줄 텍스트 처리 (매우 중요!) ⚠️
**하나의 박스 안에 여러 줄이 있는 경우:**
- ✓ 모든 줄을 읽고 하나의 항목으로 처리
- ✓ 각 줄은 \\n (줄바꿈)으로 구분
- ✓ 예: "TEL:0574-87170623\\nFAX:0574-87026831"
- ✓ 첫 줄만 읽지 말고 박스 안의 모든 텍스트 읽기!

**병렬로 표시된 수정사항:**
- ✓ 원본도 여러 줄이면 모두 읽기
- ✓ 새 텍스트도 여러 줄이면 모두 읽기
- ✓ 원본: "LDPE FT4119\\nQUANTITY. 24.75MT"
- ✓ 새 텍스트: "COMMODITY : LDPE FT4119\\nQUANTITY : 24.75MT"

### 4. 손글씨 읽기 팁:
- 대문자와 소문자 구분 주의
- 쉼표(,)와 마침표(.) 구분
- 콜론(:)과 세미콜론(;) 구분
- 숫자 0과 알파벳 O 구분
- 숫자 1과 알파벳 I/l 구분

### 5. 위치(Location) 파악:
- 텍스트가 있는 문서의 섹션/필드명 정확히 파악
- 일반적인 Bill of Lading 필드:
  * Shipper (화주)
  * Consignee (수하인)
  * Notify Party (통지처)
  * Place of Receipt (수령지)
  * Port of Loading (선적항)
  * Port of Discharge (양하항)
  * Final Destination (최종 목적지)
  * Description of Goods (화물 명세)
  * Container Number (컨테이너 번호)
  * Gross Weight (총 중량)
"""

# 정확도 향상을 위한 체크리스트
ACCURACY_CHECKLIST = """
## 분석 정확도 체크리스트

### 반드시 확인해야 할 사항:
1. ✓ **번호 표시(#1, #2, #20, #15)가 있나요? → 그 주변 반드시 확인!** ⚠️
2. ✓ 화살표가 있나요? → 수정
3. ✓ 취소선/물결/X표시가 있나요? → 삭제
4. ✓ **약한 마킹(박스, 밑줄, 동그라미)도 확인했나요?** ⚠️
5. ✓ **박스 안에 여러 줄이 있나요? → 모든 줄을 읽고 \\n으로 구분!** ⚠️
6. ✓ 손글씨를 정확히 읽었나요?
7. ✓ 대소문자를 구분했나요?
8. ✓ 문장부호를 정확히 인식했나요?
9. ✓ 숫자와 알파벳을 구분했나요?
10. ✓ 원본 텍스트 위치(필드명)를 확인했나요?
11. ✓ 모든 붉은색 마킹을 빠짐없이 찾았나요?

### 흔한 실수 방지:
❌ 화살표가 있는데 삭제로 분류
❌ 손글씨의 일부만 읽음
❌ **여러 줄 중 첫 줄만 읽음 (가장 흔한 실수!)** ⚠️
❌ **줄바꿈을 무시하고 한 줄로 합침** ⚠️
❌ U.A.E를 U.A.EMIRATES로 잘못 읽음
❌ 쉼표(,)를 빠뜨림
❌ 콜론(:)을 빠뜨림
❌ 위치를 잘못 파악

### 여러 줄 텍스트 처리 예시:
✅ 올바른 예: "TEL:0574-87170623\\nFAX:0574-87026831"
❌ 잘못된 예: "TEL:0574-87170623" (두 번째 줄 누락)
❌ 잘못된 예: "TEL:0574-87170623 FAX:0574-87026831" (줄바꿈 무시)
"""


def get_enhanced_prompt(full_page_text=""):
    """Few-Shot Learning이 적용된 향상된 프롬프트 생성"""
    
    prompt = f"""당신은 Bill of Lading 문서의 수정/삭제 지시사항을 분석하는 전문가입니다.
이미지에 표시된 붉은색 계열의 모든 수정사항을 정확하게 인식해야 합니다.

{SAMPLE_EXAMPLES}

{PATTERN_GUIDE}

{ACCURACY_CHECKLIST}

## 현재 분석 대상 문서:
이 Bill of Lading 문서를 위의 학습 예시를 참고하여 분석하세요.

### 🔍 특별 주의사항 - 반드시 확인할 필드:
⚠️ **Port of Loading (선적항)** 필드를 주의깊게 확인하세요!
- 이 필드 주변에 #20, #15, #1, #2 같은 번호 표시가 있는지 찾기
- 번호 표시가 있으면 그 주변의 모든 손글씨를 읽기
- Port of Loading 필드의 원래 텍스트가 무엇인지 확인
- 번호와 함께 표시된 새로운 텍스트가 무엇인지 확인

### 분석 절차:
1. ⚠️ **이미지를 매우 주의깊게 관찰**: 붉은/분홍/주황 계열의 모든 마킹 찾기
2. ⚠️ **번호 표시 최우선 확인**: 
   - #1, #2, #3, #15, #20, #25 등의 번호가 어디에 있는지 찾기
   - 각 번호 주변 20cm 반경 내의 모든 텍스트 읽기
   - 번호가 가리키는 원본 텍스트와 새 텍스트 파악
3. ⚠️ **Port of Loading 필드 집중 분석**:
   - Port of Loading, PORT OF LOADING, 선적항 등의 표현 찾기
   - 이 필드에 박스, 동그라미, 밑줄, 번호 표시가 있는지 확인
   - 이 필드와 연결된 손글씨가 있는지 확인
4. 각 마킹에 화살표가 있는지 확인 (있으면 수정, 없고 취소선이면 삭제)
5. ⚠️ **약한 마킹도 모두 확인**: 박스, 밑줄, 동그라미, 번호만 있어도 수정사항!
6. ⚠️ **박스 안에 여러 줄이 있는지 확인** - 있으면 모든 줄을 읽기!
7. 🔍 **원본 텍스트(검은색 인쇄)를 천천히, 정확하게 읽기**:
   - 모든 단어를 포함
   - 모든 쉼표, 마침표 포함
   - 컨테이너 번호의 모든 숫자 정확히 읽기
   - 예: "KHALIFA PORT, ABU DHABI, UAE" (전체 읽기)
   - 예: "CMAU9175970" (모든 숫자 정확히)
8. 화살표가 가리키는 손글씨를 정확히 읽기 (여러 줄이면 \\n으로 구분)
9. 번호와 연결된 손글씨 텍스트 찾기
10. 해당 텍스트가 위치한 문서 필드명 파악
11. 신뢰도 평가 (high/medium/low)

### JSON 출력 형식:
```json
[
  {{
    "order": 1,
    "action": "수정" or "삭제",
    "original_text": "박스로 표시된 원본 텍스트 (여러 줄이면 \\n으로 구분)",
    "new_text": "화살표가 가리키는 새 텍스트 (여러 줄이면 \\n으로 구분) 또는 (DELETE)",
    "location": "문서 필드명 (정확히)",
    "confidence": "high/medium/low"
  }}
]
```

### 여러 줄 텍스트 예시:
- 한 줄: "ABU DHABI, U.A.E"
- 두 줄: "TEL:0574-87170623\\nFAX:0574-87026831"
- 세 줄: "첫줄\\n둘째줄\\n셋째줄"

{f"### 문서 전체 텍스트 (참고):\\n{full_page_text[:1500]}" if full_page_text else ""}

⚠️ 🚨 매우 매우 중요 - 반드시 지켜야 할 사항 🚨 ⚠️

### 최우선 확인 사항:
1. 🔍 **이미지를 5번 이상 반복해서 보세요!**
2. 🔍 **Port of Loading 필드를 찾으세요!** (Port of Loading, PORT OF LOADING, 선적항)
3. 🔍 **Port of Loading 주변에 #20이나 #15 같은 번호가 있나요?**
4. 🔍 **있다면 그것은 100% 수정 지시사항입니다!**

### 번호 표시 처리 규칙:
- ✅ **#1, #2, #3, #15, #20, #25 등의 번호를 절대 놓치지 마세요!**
- ✅ **번호가 있으면 그 주변에 반드시 수정/삭제 지시사항이 있습니다!**
- ✅ **번호 주변 10cm 이내의 모든 손글씨를 읽으세요!**
- ✅ **번호가 어떤 원본 텍스트를 가리키는지 확인하세요!**

### 마킹 인식 규칙:
- 화살표(→)가 보이면 반드시 "수정"
- 취소선/물결/X표시만 있으면 "삭제"
- **박스, 밑줄, 동그라미, 번호 표시 = 모두 수정 지시사항!**
- **하나의 박스에 여러 줄이 있으면 모든 줄을 읽고 \\n으로 구분!**
- **TEL + FAX처럼 여러 줄이 함께 박스로 묶였으면 하나의 항목으로!**
- **첫 줄만 읽지 말고 박스 안의 모든 텍스트를 읽으세요!**

### 텍스트 읽기 규칙:
- 🔍 **원본 텍스트(검은색 인쇄된 텍스트)를 정확히 읽기** - 한 글자도 빠뜨리거나 바꾸지 마세요!
- 🔍 **숫자 정확히 읽기**: 5와 9, 7과 1, 0과 O를 구분하세요
- 🔍 **컨테이너 번호 전체 읽기**: CMAU9175970처럼 모든 숫자를 정확히
- 손글씨를 한 글자도 빠뜨리지 말고 정확히 읽기
- 대소문자, 문장부호 정확히 인식
- 모든 붉은색 마킹을 빠짐없이 분석
- **이미지에서 직접 번호를 찾고 그 주변 손글씨를 읽으세요!**

### Port of Loading 필드 특별 규칙:
- 🔴 **Port of Loading 필드에 번호나 마킹이 있으면 절대 무시하지 마세요!**
- 🔴 **#20이나 #15가 Port of Loading 근처에 있으면 반드시 분석하세요!**
- 🔴 **Port of Loading의 원본 텍스트를 완전하게 읽으세요!**
  - 예: "KHALIFA PORT, ABU DHABI, UAE" (전체를 읽기)
  - ❌ "KHALIFA PORT, UAE" (중간 부분 생략하지 마세요!)

### 원본 텍스트(검은색 인쇄) 읽기 규칙:
- 🔍 **검은색으로 인쇄된 원본 텍스트를 100% 정확하게 읽으세요**
- 🔍 **한 글자, 한 단어도 빠뜨리지 마세요**
- 🔍 **쉼표, 마침표도 그대로 포함하세요**
- 🔍 **컨테이너 번호는 모든 숫자를 정확히 읽으세요**
  - 예: CMAU9175970 (9175970을 정확히)
  - ❌ CMAU9157090 (숫자를 바꾸지 마세요!)
- 🔍 **5와 9, 7과 1, 0과 O를 정확히 구분하세요**

JSON 배열만 반환하세요."""
    
    return prompt
