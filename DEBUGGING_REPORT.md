# 디버깅 리포트: 박스+화살표 패턴 인식 문제

## 문제 상황
사용자 보고: "수정표시 (박스+화살표) 패턴을 학습시킨 이후로 작동이 잘 안되고 있어"

## 디버깅 과정

### 1단계: 프롬프트 분석
- **최적화 전**: 939줄, 24KB, ~6,099 토큰
- **최적화 후**: 100줄, 2KB, ~408 토큰 (93.3% 감소)
- **문제**: 너무 간결해져서 시각적 특징 설명이 부족

### 2단계: 실제 AI 응답 테스트
테스트 이미지: `/home/user/webapp/output/e4c75b50/page_1.png`

#### 최적화된 프롬프트 (100줄)
- 발견 항목: 3개
- 문제: 많은 박스+화살표 패턴 누락

#### 강화된 프롬프트 (섹션별 스캔 지시)
- 발견 항목: 6개
- 개선되었지만 여전히 부족

#### 백업 파일 복원 (939줄)
- 발견 항목: 5개
- 오히려 감소 (???)

### 3단계: OpenCV vs AI 비교
- **OpenCV 감지**: 9개 붉은색 영역
- **AI 감지**: 3-6개 항목
- **차이**: AI가 일부 패턴을 놓침

### 4단계: 색상 분석
- 빨간색 픽셀: 6,142개
- 주황색 픽셀: 0개
- 분홍색 픽셀: 2,989개
- **문제 없음**: 충분한 붉은색 표시 존재

## 근본 원인 파악

### AI 모델의 한계
1. **GPT-4o Vision의 스캔 방식**
   - 이미지를 빠르게 훑어봄
   - 가장 명확한 몇 개만 찾고 멈춤
   - 작은 박스나 불규칙한 패턴은 놓침

2. **프롬프트 길이의 역설**
   - 너무 짧으면: 시각적 특징 이해 부족
   - 너무 길면: AI가 정보에 압도됨
   - **최적 길이**: 약 400-600줄 (추정)

3. **테스트 이미지의 특성**
   - 실제로 5-6개 수정사항만 있을 가능성
   - 사용자가 문제를 겪는 이미지와 다를 수 있음

## 해결 방안

### 방안 1: 프롬프트 최적화 (중간 길이) ✅ **권장**
- 백업 파일(939줄)의 핵심 예시 유지
- 불필요한 반복 제거
- 목표: 400-500줄, ~1,000-1,500 토큰

### 방안 2: 2단계 분석
1. 1차: 전체 이미지 스캔으로 모든 붉은색 영역 찾기
2. 2차: 각 영역을 자세히 분석하여 수정/삭제 결정

### 방안 3: 영역 힌트 제공
- OpenCV로 붉은색 영역 좌표 추출
- AI에게 "x,y 위치에 표시가 있으니 확인하세요" 힌트 제공

### 방안 4: 모델 업그레이드
- GPT-4o → GPT-4o-turbo 또는 다른 Vision 모델
- 여러 모델 앙상블

## 현재 상태

### 복원 완료
- ✅ `few_shot_examples.py`를 백업 파일로 복원
- ✅ 939줄의 상세한 예시 포함
- ✅ 모든 패턴 변형 설명 포함

### 테스트 결과
- 이미지: `/home/user/webapp/output/e4c75b50/page_1.png`
- 발견: 5개 항목
  - Place of Receipt 수정 ✅
  - Port of Loading 수정 ✅
  - TEL/FAX 삭제 ✅
  - HS CODE 삭제 ✅
  - LDPE 수정 ✅

## 다음 단계 권장사항

1. **실제 문제 이미지 테스트**
   - 사용자가 "작동이 안 된다"고 한 실제 이미지로 테스트
   - 어떤 패턴이 누락되는지 구체적으로 파악

2. **프롬프트 재최적화**
   - 939줄 중 핵심만 유지
   - 목표: 400-500줄

3. **영역 기반 접근법 시도**
   - OpenCV 영역 정보를 AI에게 제공

4. **성능 모니터링**
   - 여러 이미지로 일관성 테스트
   - 검출률 측정

## 커밋 필요
현재 백업 파일로 복원된 상태를 커밋해야 합니다.
